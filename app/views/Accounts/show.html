#{extends 'main.html' /}
#{set title:'Compte' /}

#{form @Accounts.show(accountId), method:'GET', class:'form-inline'}
	#{select 'month', items:months, value:month}
	#{/select}

	#{select 'year', items:years, value:year}
	#{/select}

	<button class="btn btn-primary" type="submit">Valider</button>
#{/form}

<div id="dialog-form">
	#{form @Transactions.create(), id:'createRegularTransactionForm', method:'POST'}
		<input name="accountId" type="hidden" value="${accountId}">
		<input id="transactionId" name="transactionId" type="hidden">

		<div>
			<label>Catégorie</label>
			#{select 'categoryId', items:categories, valueProperty:'id', labelProperty:'label', id:'transactionCategory'}
				#{option}#{/option}
			#{/select}
		</div>

		<div>
			<label>Intitulé</label>
			<input id="transactionLabel" name="label" type="text" placeholder="Intitulé">
		</div>

		<div>
			<label>Montant</label>
			<input id="transactionAmount" name="amount" type="text" placeholder="Montant">
		</div>

		<div>
			<label>Date</label>
			<input id="transactionDate" name="date" type="text">
		</div>
	#{/form}
</div>

<table id="regularTransactions" class="table table-hover">
	<thead>
		<tr>
			<th>Intitulé</th>
			<th>Montant</th>
			<th>Date</th>
			<th>Actions</th>
		</tr>
	</thead>

	<tfoot>
		<tr id="createRegularTransactionTr">
			<td colspan="3"></td>
			<td><a id="createRegularTransactionLink" href="#"><i class="icon-plus"></i></a></td>
		</tr>
	</tfoot>

	<tbody>
		#{list as:'category', items:regularTransactions.keySet()}
			<tr>
				<td><a href="#" data-action="expand" data-category-id="${category.id}"><i class="icon-chevron-down"></i>&nbsp;${category.label}</a></td>
				<td colspan="3"></td>
			</tr>

			#{list as:'transaction', items:regularTransactions.get(category)}
				<tr class="${(transaction.done == true) ? 'success' : 'error'}" data-category-id="${category.id}">
					<td>${transaction.configuration.label}</td>
					<td>${transaction.configuration.amount.formatCurrency(messages.get('currency'))}</td>
					<td class="transaction-amount" style="display: none;">${transaction.configuration.amount}</td>
					<td>${transaction.date.toDate().format()}</td>
					<td><a href="@{Transactions.deactivate(transaction.configuration.id)}" data-action="delete"><i class="icon-off"></i></a></td>
				</tr>
			#{/list}
		#{/list}
	</tbody>
</table>

<table id="oneOffTransactions" class="table table-hover">
	<thead>
		<tr>
			<th>Intitulé</th>
			<th>Montant</th>
			<th>Date</th>
			<th>Actions</th>
		</tr>
	</thead>

	<tbody>
		#{list as:'transaction', items:oneOffTransactions}
			<tr data-transaction-id="${transaction.id}">
				<td class="transaction-label">${transaction.label}</td>
				<td>${transaction.amount.formatCurrency(messages.get('currency'))}</td>
				<td class="transaction-amount" style="display: none;">${transaction.amount}</td>
				<td class="transaction-date">${transaction.date.toDate().format()}</td>
				<td><a href="#" data-action="create"><i class="icon-calendar"></i></a></td>
			</tr>
		#{/list}
	</tbody>
</table>

<script type="text/javascript">
	$(function() {
		var regularTransactions = $('#regularTransactions > tbody');
		var oneOffTransactions = $('#oneOffTransactions > tbody');
		var form = $('#createRegularTransactionForm');

		/* Dialog configuration */
		$('#dialog-form').dialog({
			autoOpen: false,
			buttons: {
				'Valider': function() {
					form.submit();
				},
				'Annuler': function() {
					$(this).dialog('close');
				}
			},
			height: 375,
			modal: true,
			width: 450,
		});

		/* Datepicker input */
		$('#transactionDate').datepicker({
			buttonImage: '',
			buttonImageOnly: true,
			dateFormat: 'dd/mm/yy',
			minDate: '01/${currentMonth}/${currentYear}',
			showOn: 'button'
		});

		/* Form submission */
		form.submit(function() {
			return confirm('Êtes-vous sûr de vouloir ajouter cette transaction permanente ?');
		});

		/* Regular transaction expansion from regular transactions table */
		regularTransactions.find('a[data-action="expand"]').click(function() {
			var categoryId = $(this).data('category-id');
			regularTransactions.find('tr[data-category-id="' + categoryId + '"]').toggle();
			
			return false;
		});

		/* Regular transaction creation from regular transactions table */
		$('#createRegularTransactionLink').click(function() {
			$('#transactionId').val('').prop('disabled', true);
			$('#transactionCategory').val('');
			$('#transactionLabel').val('').prop('disabled', false);
			$('#transactionAmount').val('').prop('disabled', false);
			$('#transactionDate').val('');

			$('#dialog-form').dialog('open');

			return false;
		});

		/* Regular transaction deletion from regular transactions table */
		regularTransactions.find('a[data-action="delete"]').click(function() {
			return confirm('Êtes-vous sûr de vouloir supprimer cette transaction permanente ?');
		});

		/* Regular transaction creation from one-off transactions table */
		oneOffTransactions.find('a[data-action="create"]').click(function() {
			var tr = $(this).closest('tr[data-transaction-id]');
			var transactionId = tr.data('transaction-id');
			var label = tr.find('.transaction-label').text();
			var amount = tr.find('.transaction-amount').text();
			var date = tr.find('.transaction-date').text();

			$('#transactionId').val(transactionId).prop('disabled', false);
			$('#transactionCategory').val('');
			$('#transactionLabel').val(label).prop('disabled', true);
			$('#transactionAmount').val(amount).prop('disabled', true);
			$('#transactionDate').val(date);

			$('#dialog-form').dialog('open');

			return false;
		});
	});
</script>
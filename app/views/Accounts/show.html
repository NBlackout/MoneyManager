#{extends 'main.html' /}
#{set title:messages.get('titles.accounts.show') /}

#{form @Accounts.show(accountId), method:'GET', id:'dateForm', class:'form-inline'}
	<input id="dateYear" type="hidden" value="${year}">
	<input id="dateMonth" type="hidden" value="${month}">

	<select id="dates">
		#{list as:'date', items:dates}
			<option data-year="${date.toDate().format('yyyy')}" data-month="${date.toDate().format('M')}">${date.toDate().format(messages.get('date.format.month'))}</option>
		#{/list}
	</select>

	<button class="btn btn-primary" type="submit">&{'actions.validate'}</button>
#{/form}

<div id="dialog">
	#{form @Transactions.create(), id:'createRegularTransactionForm', method:'POST'}
		<input id="transactionId" name="transactionId" type="hidden">

		<div>
			<label>Catégorie</label>
			#{select 'categoryId', items:categories, labelProperty:'label', id:'transactionCategory'}
				#{option}#{/option}
			#{/select}
		</div>

		<div>
			<label>&{'labels.label.friendly'}</label>
			<input id="transactionFriendlyLabel" name="friendlyLabel" type="text" placeholder="&{'labels.label.friendly'}">
		</div>

		<div>
			<label>&{'labels.date'}</label>
			<input id="transactionDate" name="date" type="text" placeholder="&{'labels.date'}">
		</div>
	#{/form}
</div>

<table id="regularTransactions" class="table table-hover">
	<thead>
		<tr>
			<th>&{'labels.label'}</th>
			<th>&{'labels.amount'}</th>
			<th>&{'labels.date'}</th>
			<th>&{'labels.actions'}</th>
		</tr>
	</thead>

	<tbody>
		#{list as:'category', items:regularTransactions.keySet()}
			%{
				Double total = categoryTotals.get(category);
			}%

			<tr>
				<td><a href="#" data-action="expand" data-category-id="${category.id}"><i class="icon-chevron-down"></i>&nbsp;${category.label}</a></td>
				<td class="${(total < 0) ? 'debit' : ((total > 0) ? 'credit' : 'neutral')}">${total?.formatCurrency(messages.get('currency'))}</td>
				<td colspan="2"></td>
			</tr>

			#{list as:'transaction', items:regularTransactions.get(category)}
				%{
					Double amount = transaction.amount;
				}%

				<tr class="${(transaction.done == true) ? 'success' : 'error'}" data-category-id="${category.id}">
					<td>${transaction.configuration.friendlyLabel}</td>
					<td class="${(amount < 0) ? 'debit' : ((amount > 0) ? 'credit' : 'neutral')}">${amount?.formatCurrency(messages.get('currency'))}</td>
					<td>${transaction.date.toDate().format(messages.get('date.format'))}</td>
					<td>
						<a href="@{Transactions.generate(transaction.configuration.id)}"><i class="icon-cog"></i></a>
						<a href="@{Transactions.deactivate(transaction.configuration.id)}" data-action="delete"><i class="${transaction.configuration.active == true ? 'icon-step-forward' : 'icon-off'}"></i></a>
					</td>
				</tr>
			#{/list}
		#{/list}
	</tbody>
</table>

<table id="oneOffTransactions" class="table table-hover">
	<thead>
		<tr>
			<th>&{'labels.label'}</th>
			<th>&{'labels.amount'}</th>
			<th>&{'labels.date'}</th>
			<th>&{'labels.pay.monthly'}</th>
		</tr>
	</thead>

	<tbody>
		#{list as:'transaction', items:oneOffTransactions}
			%{
				double amount = transaction.amount;
			}%

			<tr data-transaction-id="${transaction.id}">
				<td>${transaction.label}</td>
				<td class="${(amount < 0) ? 'debit' : ((amount > 0) ? 'credit' : 'neutral')}">${amount.formatCurrency(messages.get('currency'))}</td>
				<td class="transaction-date">${transaction.date.toDate().format(messages.get('date.format'))}</td>
				<td><a href="#" data-action="create"><i class="icon-calendar"></i></a></td>
			</tr>
		#{/list}
	</tbody>
</table>

<script type="text/javascript">
	var dialog = $('#dialog');

	function initDateForm() {
		var dates = $('#dates');
		var form = $('#dateForm');

		dates.find('option').each(function() {
			var date = $(this);
			var year = date.data('year');
			var month = date.data('month');

			if (year == $('#dateYear').val() && month == $('#dateMonth').val()) {
				date.attr('selected', 'selected');

				return false;
			}
		});

		form.submit(function() {
			var date = $('#dates :selected');
			var year = date.data('year');
			var month = date.data('month');

			window.location = form.attr('action') + '/' + year + '/' + month;

			return false;
		});
	};

	function initDialog() {
		var form = $('#createRegularTransactionForm');

		/* Buttons configuration */
		var buttons = {};
		buttons[messages['actions.validate']] = function() {
			form.submit();
		};
		buttons[messages['actions.cancel']] = function() {
			$('#dialog').dialog('close')
		};

		/* Dialog configuration */
		$('#dialog').dialog({
			autoOpen: false,
			buttons: buttons,
			height: 375,
			modal: true,
			width: 450,
		});

		/* Datepicker input */
		$('#transactionDate').datepicker({
			buttonImage: '',
			buttonImageOnly: true,
			dateFormat: 'dd/mm/yy',
			minDate: '01/${currentMonth}/${currentYear}',
			showOn: 'button'
		});

		/* Form submission */
		form.submit(function() {
			return confirm('Êtes-vous sûr de vouloir ajouter cette transaction permanente ?');
		});
	};

	function initRegularTransactionsTable() {
		var regularTransactions = $('#regularTransactions > tbody');

		/* Regular transaction expansion from regular transactions table */
		regularTransactions.find('a[data-action="expand"]').click(function() {
			var categoryId = $(this).data('category-id');
			var i = $(this).find('i');

			if (i.hasClass('icon-chevron-down')) {
				regularTransactions.find('tr[data-category-id="' + categoryId + '"]').hide();

				i.removeClass('icon-chevron-down');
				i.addClass('icon-chevron-right');
			} else {
				regularTransactions.find('tr[data-category-id="' + categoryId + '"]').show();

				i.removeClass('icon-chevron-right');
				i.addClass('icon-chevron-down');
			}

			return false;
		});

		/* Regular transaction deletion from regular transactions table */
		regularTransactions.find('a[data-action="delete"]').click(function() {
			return confirm('Êtes-vous sûr de vouloir supprimer cette transaction permanente ?');
		});
	};

	function initOneOffTransactionsTable() {
		var oneOffTransactions = $('#oneOffTransactions > tbody');

		/* Regular transaction creation from one-off transactions table */
		oneOffTransactions.find('a[data-action="create"]').click(function() {
			var tr = $(this).closest('tr[data-transaction-id]');
			var transactionId = tr.data('transaction-id');
			var date = tr.find('.transaction-date').text();

			$('#transactionId').val(transactionId).prop('disabled', false);
			$('#transactionCategory').val('');
			$('#transactionDate').val(date);

			dialog.dialog('open');

			return false;
		});
	};

	$(function() {
		initDateForm();
		initDialog();
		initRegularTransactionsTable();
		initOneOffTransactionsTable();
	});
</script>